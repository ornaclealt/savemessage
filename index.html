<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Tamu Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-slate-800">Buku Tamu Digital</h1>
            <span id="status-badge" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">
                Memuat Sistem...
            </span>
        </div>
    </nav>

    <main class="flex-grow max-w-3xl mx-auto px-4 py-8 w-full">
        <!-- Notifikasi Mode -->
        <div id="mode-notification" class="hidden mb-6 p-4 bg-blue-50 border border-blue-100 rounded-lg text-sm text-blue-800">
            <!-- Isi notifikasi akan diatur via JS -->
        </div>

        <!-- Input Form -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4 text-slate-700">Tulis Pesan</h2>
            <form id="guestbook-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Nama</label>
                    <input type="text" id="name" required placeholder="Nama Anda" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-100 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Pesan</label>
                    <textarea id="message" required rows="3" placeholder="Tulis pesan di sini..." class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-100 outline-none resize-none"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">
                        Kirim Pesan
                    </button>
                </div>
            </form>
        </section>

        <!-- Message List -->
        <section>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Riwayat Pesan</h2>
                <button onclick="resetLocalData()" id="reset-btn" class="hidden text-xs text-red-400 hover:text-red-600">Reset Data</button>
            </div>
            <div id="messages-container" class="space-y-3">
                <p class="text-center text-gray-400 py-8">Memuat...</p>
            </div>
        </section>
    </main>

    <!-- Script Utama (Hybrid System) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- SISTEM DETEKSI OTOMATIS ---
        let useLocalStorage = false;
        let db, auth, user, appId;
        const COLLECTION_NAME = 'guestbook_auto';

        // Elemen UI
        const statusBadge = document.getElementById('status-badge');
        const notifBox = document.getElementById('mode-notification');
        const container = document.getElementById('messages-container');
        const form = document.getElementById('guestbook-form');
        const resetBtn = document.getElementById('reset-btn');

        async function initSystem() {
            // 1. Cek apakah ada config Firebase dari environment (Preview Mode)
            if (typeof __firebase_config !== 'undefined') {
                console.log("Mode: Online (Preview)");
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Login
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                setupRealtimeListener();
                updateStatusUI("Online (Cloud)", "green");
            
            } else {
                // 2. Jika di GitHub dan tidak ada config -> MODE OFFLINE/LOCAL
                console.log("Mode: Offline (GitHub/Local)");
                useLocalStorage = true;
                user = { uid: 'local-user' }; // User palsu
                
                setupLocalListener();
                updateStatusUI("Mode Demo (Lokal)", "orange");
                
                // Tampilkan info ke user
                notifBox.classList.remove('hidden');
                notifBox.innerHTML = `
                    <strong>Info Mode Demo:</strong> Karena belum ada backend terhubung, 
                    sistem beralih ke penyimpanan browser. Pesan Anda tetap tersimpan di HP/Laptop ini, 
                    tapi tidak bisa dilihat orang lain secara online.
                `;
                resetBtn.classList.remove('hidden');
            }
        }

        // --- FUNGSI UPDATE UI ---
        function updateStatusUI(text, color) {
            const colors = {
                green: "bg-green-100 text-green-700",
                orange: "bg-orange-100 text-orange-700",
                gray: "bg-gray-100 text-gray-600"
            };
            statusBadge.className = `px-3 py-1 rounded-full text-xs font-medium ${colors[color] || colors.gray}`;
            statusBadge.innerText = text;
        }

        function renderMessages(messages) {
            container.innerHTML = '';
            if (messages.length === 0) {
                container.innerHTML = `<div class="text-center py-10 border border-dashed border-slate-300 rounded-xl text-slate-400">Belum ada pesan.</div>`;
                return;
            }

            messages.forEach(msg => {
                const date = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'Baru saja';
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start';
                div.innerHTML = `
                    <div>
                        <h3 class="font-bold text-slate-700">${escapeHtml(msg.name)}</h3>
                        <p class="text-slate-600 mt-1">${escapeHtml(msg.text)}</p>
                        <span class="text-xs text-slate-400 mt-2 block">${date}</span>
                    </div>
                    <button onclick="window.deleteItem('${msg.id}')" class="text-red-300 hover:text-red-500 font-bold text-xl px-2">&times;</button>
                `;
                container.appendChild(div);
            });
        }

        // --- LOGIKA FIREBASE (ONLINE) ---
        function setupRealtimeListener() {
            // Path khusus untuk environment ini
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const msgs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() // Konversi timestamp firebase
                }));
                renderMessages(msgs);
            });
        }

        // --- LOGIKA LOCAL STORAGE (OFFLINE/GITHUB) ---
        function setupLocalListener() {
            loadLocalData();
            // LocalStorage tidak punya real-time listener bawaan antar tab, 
            // jadi kita refresh manual saat ada aksi.
        }

        function loadLocalData() {
            const data = localStorage.getItem('guestbook_local_data');
            const msgs = data ? JSON.parse(data) : [];
            // Sort terbaru di atas
            msgs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderMessages(msgs);
        }

        function saveLocalData(name, text) {
            const data = localStorage.getItem('guestbook_local_data');
            const msgs = data ? JSON.parse(data) : [];
            
            msgs.push({
                id: 'local_' + Date.now(),
                name: name,
                text: text,
                timestamp: new Date().toISOString(), // Simpan string ISO
                userId: 'local-user'
            });
            
            localStorage.setItem('guestbook_local_data', JSON.stringify(msgs));
            loadLocalData(); // Refresh UI
        }

        // --- HANDLER FORM ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const text = document.getElementById('message').value;
            const btn = document.getElementById('submit-btn');

            btn.disabled = true;
            btn.innerText = "Mengirim...";

            try {
                if (useLocalStorage) {
                    // Simpan Lokal
                    saveLocalData(name, text);
                    // Simulasi delay jaringan sedikit biar terasa 'real'
                    await new Promise(r => setTimeout(r, 500)); 
                } else {
                    // Simpan Cloud
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                        name: name,
                        text: text,
                        timestamp: serverTimestamp(),
                        userId: auth.currentUser.uid
                    });
                }
                form.reset();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Kirim Pesan";
            }
        });

        // --- HANDLER DELETE (GLOBAL) ---
        window.deleteItem = async (id) => {
            if(!confirm("Hapus pesan ini?")) return;

            if (useLocalStorage) {
                const data = JSON.parse(localStorage.getItem('guestbook_local_data') || "[]");
                const newData = data.filter(item => item.id !== id);
                localStorage.setItem('guestbook_local_data', JSON.stringify(newData));
                loadLocalData();
            } else {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, id));
            }
        };

        window.resetLocalData = () => {
            if(confirm("Hapus semua data lokal?")) {
                localStorage.removeItem('guestbook_local_data');
                loadLocalData();
            }
        };

        function escapeHtml(text) {
            return text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        }

        // Jalankan Sistem
        initSystem();

    </script>
</body>
</html>
